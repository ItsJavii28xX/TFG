<div class="details-layout">
  <!-- ==== PANELO PRINCIPAL ==== -->
  <mat-card class="details-card">
    <!-- Cabecera igual -->
    <div class="header">
      <h1>{{ (group$ | async)?.nombre }}</h1>
    </div>
    <p class="creation-date">
      Creado el {{ (group$ | async)?.fecha_creacion | date:'longDate' }}
    </p>

    <!-- Miembros paginados -->
    <section class="members">
      <h2>ðŸ‘¥ Miembros</h2>
      <div class="pager">
        <button mat-icon-button (click)="prevPage()" [disabled]="pageIndex$.value===0">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span>{{ pageIndex$.value+1 }} / {{ totalPages }}</span>
        <button mat-icon-button (click)="nextPage()" [disabled]="pageIndex$.value+1>=totalPages">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
      <mat-list>
        <mat-list-item *ngFor="let u of members$ | async">
          <mat-checkbox
            *ngIf="deleteMemberMode"
            (change)="toggleSelectMember(u, $event.checked)"
            aria-label="Marcar miembro">
          </mat-checkbox>

          <!-- Avatar y datos -->
          <img matListAvatar [src]="u.imagen_perfil" alt="{{u.nombre}}" (click)="goToProfile(u)"/>
          <div matLine class="member-name" (click)="goToProfile(u)">{{ u.nombre }} {{ u.apellidos }}</div>
          <div matLine class="member-email" (click)="goToProfile(u)">
            <mat-icon inline>email</mat-icon> {{ u.email }}
          </div>
        </mat-list-item>

        <mat-list-item *ngIf="(members$ | async)?.length === 0">
          No hay miembros en este grupo
        </mat-list-item>
      </mat-list>

      <!-- Formulario AÃ±adir Miembro -->
      <app-members-select
        *ngIf="showAddMemberForm"
        (done)="onMembersDone($event)"
        (cancel)="showAddMemberForm = false">
      </app-members-select>

      <!-- Botones de Confirmar/Cancelar selecciÃ³n -->
      <div *ngIf="deleteMemberMode && selectedMembers.length">
        <button mat-button color="warn" (click)="openConfirmDeleteMembers()">
          Eliminar {{ selectedMembers.length }} miembro(s)
        </button>
        <button mat-button (click)="cancelDeleteMembers()">Cancelar</button>
      </div>
    </section>

    <!-- Presupuestos -->
    <section class="budgets">
      <h2>ðŸ’° Presupuestos</h2>
      <mat-list *ngIf="(budgets$ | async) as budgets; else noBudgets">
        <mat-list-item *ngFor="let b of budgets">
          <mat-checkbox
            *ngIf="deleteBudgetMode"
            (change)="toggleSelectBudget(b, $event.checked)"
            aria-label="Marcar presupuesto">
          </mat-checkbox>

          <!-- BotÃ³n de editar presupuesto -->
          <button
            mat-icon-button
            *ngIf="updateBudgetMode"
            (click)="toggleUpdateBudgetMode(b)"
            aria-label="Editar presupuesto"
          >
            <mat-icon>edit</mat-icon>
          </button>

          <!-- Datos del presupuesto -->
          <div matLine>
            <strong>{{ b.nombre }}</strong>
            {{ b.fecha_inicio | date:'shortDate' }} â€“ {{ b.fecha_fin | date:'shortDate' }}
          </div>
          <div matLine class="budget-amount">{{ b.cantidad | currency }}</div>
        </mat-list-item>
      </mat-list>

      <div *ngIf="deleteBudgetMode && selectedBudgets.length">
        <button mat-button color="warn" (click)="openConfirmDeleteBudgets()">
          Eliminar {{ selectedBudgets.length }} presupuesto(s)
        </button>
        <button mat-button (click)="cancelDeleteBudgets()">Cancelar</button>
      </div>

      <ng-template #noBudgets>
        <p class="no-budget">No hay presupuestos</p>
      </ng-template>

      <!-- Formulario AÃ±adir Presupuesto -->
      <form
        *ngIf="showAddBudgetForm"
        [formGroup]="addBudgetForm"
        class="inline-form"
        (ngSubmit)="submitAddBudget()"
      >
        <mat-form-field appearance="fill">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" required />
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="cantidad" required />
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Fecha Inicio</mat-label>
          <input matInput [matDatepicker]="bi" formControlName="fechaInicio" required />
          <mat-datepicker-toggle matSuffix [for]="bi"></mat-datepicker-toggle>
          <mat-datepicker #bi></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Fecha Fin</mat-label>
          <input matInput [matDatepicker]="bf" formControlName="fechaFin" required />
          <mat-datepicker-toggle matSuffix [for]="bf"></mat-datepicker-toggle>
          <mat-datepicker #bf></mat-datepicker>
        </mat-form-field>
        <div class="form-buttons">
          <button mat-raised-button color="primary" type="submit" [disabled]="addBudgetForm.invalid">
            AÃ±adir
          </button>
          <button mat-button type="button" (click)="toggleAddBudgetForm()">Cancelar</button>
        </div>
      </form>

      <!-- Formulario Editar Presupuesto -->
      <form
        *ngIf="updateBudgetMode"
        [formGroup]="updateBudgetForm"
        class="inline-form"
        (ngSubmit)="submitUpdateBudget()"
      >
        <mat-form-field appearance="fill">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" required />
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="cantidad" required />
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Fecha Inicio</mat-label>
          <input matInput [matDatepicker]="ebi" formControlName="fecha_inicio" required />
          <mat-datepicker-toggle matSuffix [for]="ebi"></mat-datepicker-toggle>
          <mat-datepicker #ebi></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Fecha Fin</mat-label>
          <input matInput [matDatepicker]="ebf" formControlName="fecha_fin" required />
          <mat-datepicker-toggle matSuffix [for]="ebf"></mat-datepicker-toggle>
          <mat-datepicker #ebf></mat-datepicker>
        </mat-form-field>
        <div class="form-buttons">
          <button mat-raised-button color="accent" type="submit" [disabled]="updateBudgetForm.invalid">
            Guardar
          </button>
          <button mat-button type="button" (click)="toggleUpdateBudgetMode()">Cancelar</button>
        </div>
      </form>
    </section>

    <!-- Gastos -->
    <section class="expenses">
      <h2>ðŸ’¸ Gastos</h2>
      <mat-list *ngIf="(gastos$ | async) as gastos; else noExpenses">
        <mat-list-item *ngFor="let g of gastos">
          <!-- Checkbox de borrar gasto -->
          <mat-checkbox
            *ngIf="deleteExpenseMode"
            (change)="toggleSelectExpense(g, $event.checked)"
            aria-label="Marcar gasto">
          </mat-checkbox>
          <!-- BotÃ³n de editar gasto -->
          <button
            mat-icon-button
            *ngIf="updateExpenseMode"
            (click)="toggleUpdateExpenseMode(g)"
            aria-label="Editar gasto"
          >
            <mat-icon>edit</mat-icon>
          </button>

          <!-- Datos del gasto -->
          <div matLine>{{ g.descripcion }} â€“ {{ g.cantidad | currency }}</div>
          <div matLine class="expense-date">{{ g.fecha_creacion | date:'shortDate' }}</div>
        </mat-list-item>
      </mat-list>

      <div *ngIf="deleteExpenseMode && selectedExpenses.length">
        <button mat-button color="warn" (click)="openConfirmDeleteExpenses()">
          Eliminar {{ selectedExpenses.length }} gasto(s)
        </button>
        <button mat-button (click)="cancelDeleteExpenses()">Cancelar</button>
      </div>

      <ng-template #noExpenses>
        <p class="no-expenses">No hay gastos registrados</p>
      </ng-template>

      <!-- Formulario AÃ±adir Gasto -->
      <form
        *ngIf="showAddExpenseForm"
        [formGroup]="addExpenseForm"
        class="inline-form"
        (ngSubmit)="submitAddExpense()"
      >
        <mat-form-field appearance="fill">
          <mat-label>DescripciÃ³n</mat-label>
          <input matInput formControlName="descripcion" required />
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="cantidad" required />
        </mat-form-field>
        <div class="form-buttons">
          <button mat-raised-button color="primary" type="submit" [disabled]="addExpenseForm.invalid">
            AÃ±adir
          </button>
          <button mat-button type="button" (click)="toggleAddExpenseForm()">Cancelar</button>
        </div>
      </form>

      <!-- Formulario Editar Gasto -->
      <form
        *ngIf="updateExpenseMode"
        [formGroup]="updateExpenseForm"
        class="inline-form"
        (ngSubmit)="submitUpdateExpense()"
      >
        <mat-form-field appearance="fill">
          <mat-label>DescripciÃ³n</mat-label>
          <input matInput formControlName="descripcion" required />
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="cantidad" required />
        </mat-form-field>
        <div class="form-buttons">
          <button mat-raised-button color="accent" type="submit" [disabled]="updateExpenseForm.invalid">
            Guardar
          </button>
          <button mat-button type="button" (click)="toggleUpdateExpenseMode()">Cancelar</button>
        </div>
      </form>
    </section>

    <button mat-stroked-button color="warn" class="back-btn" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon> Volver
    </button>
  </mat-card>

  <!-- ==== PANEL DE GESTIÃ“N ==== -->
  <mat-nav-list class="management-panel">
    <h3>GestiÃ³n</h3>
    <mat-divider></mat-divider>

    <!-- === Miembros === -->
    <ng-container *ngIf="isAdmin; else noAdminMiembros">
      <mat-list-item>
        <mat-icon matListIcon>group</mat-icon>
        <h4 matLine>Miembros</h4>
        <button mat-mini-fab color="primary" (click)="toggleAddMemberForm()">
          <mat-icon>person_add</mat-icon>
        </button>
        <button mat-mini-fab color="warn" (click)="toggleDeleteMemberMode()">
          <mat-icon>person_remove</mat-icon>
        </button>
      </mat-list-item>
    </ng-container>
    <ng-template #noAdminMiembros>
      <mat-list-item>
        <mat-icon matListIcon>block</mat-icon>
        <h4 matLine>Miembros</h4>
        <p matLine class="not-admin-msg">
          Necesitas ser administrador
        </p>
      </mat-list-item>
    </ng-template>

    <!-- === Presupuestos === -->
    <ng-container *ngIf="isAdmin; else noAdminPresupuestos">
      <mat-list-item>
        <mat-icon matListIcon>account_balance_wallet</mat-icon>
        <h4 matLine>Presupuestos</h4>
        <button mat-mini-fab color="primary" (click)="toggleAddBudgetForm()">
          <mat-icon>add</mat-icon>
        </button>
        <button mat-mini-fab color="warn" (click)="toggleDeleteBudgetMode()">
          <mat-icon>delete</mat-icon>
        </button>
        <button mat-mini-fab color="accent" (click)="openEditBudgetOverlay()">
          <mat-icon>edit</mat-icon>
        </button>
      </mat-list-item>
    </ng-container>
    <ng-template #noAdminPresupuestos>
      <mat-list-item>
        <mat-icon matListIcon>block</mat-icon>
        <h4 matLine>Presupuestos</h4>
        <p matLine class="not-admin-msg">
          Necesitas ser administrador
        </p>
      </mat-list-item>
    </ng-template>

    <!-- === Gastos (sin restricciÃ³n) === -->
    <mat-list-item>
      <mat-icon matListIcon>shopping_cart</mat-icon>
      <h4 matLine>Gastos</h4>
      <button mat-mini-fab color="primary" (click)="toggleAddExpenseForm()">
        <mat-icon>add</mat-icon>
      </button>
      <button mat-mini-fab color="warn" (click)="toggleDeleteExpenseMode()">
        <mat-icon>delete</mat-icon>
      </button>
      <button mat-mini-fab color="accent" (click)="toggleUpdateExpenseMode()">
        <mat-icon>edit</mat-icon>
      </button>
    </mat-list-item>
  </mat-nav-list>
</div>

<!-- â‘  Overlay de EdiciÃ³n -->
<div class="overlay-2" *ngIf="showEditBudgetOverlay">
  <mat-card class="overlay-card-2">
    <mat-card-header>
      <mat-card-title>Editar presupuesto</mat-card-title>
    </mat-card-header>

    <mat-card-content [formGroup]="editBudgetForm">
      <!-- Selector del presupuesto -->
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Selecciona presupuesto</mat-label>
        <mat-select
          panelClass="above-overlay-panel"
          formControlName="presupuestoSeleccionado"
          (selectionChange)="onBudgetSelected($event.value)"
        >
          <mat-option *ngFor="let b of budgetsSnapshot" [value]="b.id_presupuesto">
            {{ b.nombre }} ({{ b.fecha_inicio | date:'shortDate' }} â€“ {{ b.fecha_fin | date:'shortDate' }})
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Si ya elegiste uno, muestra campos -->
      <ng-container *ngIf="budgetToEditOverlay">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre">
        </mat-form-field>
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>DescripciÃ³n</mat-label>
          <textarea matInput formControlName="descripcion"></textarea>
        </mat-form-field>
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="cantidad">
        </mat-form-field>
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Fecha Fin</mat-label>
          <input matInput [matDatepicker]="editFin" formControlName="fecha_fin">
          <mat-datepicker-toggle matSuffix [for]="editFin"></mat-datepicker-toggle>
          <mat-datepicker #editFin></mat-datepicker>
        </mat-form-field>
      </ng-container>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="cancelEditBudget()">Cancelar</button>
      <button mat-raised-button color="primary" (click)="goToReviewBudget()"
              [disabled]="!budgetToEditOverlay || editBudgetForm.invalid">
        Siguiente
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<!-- â‘¡ Overlay de RevisiÃ³n -->
<div class="overlay" *ngIf="showReviewBudgetOverlay">
  <mat-card class="overlay-card">
    <mat-card-header>
      <mat-card-title>Revisar cambios</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <p>Vas a cambiar:</p>
      <mat-list dense>
        <mat-list-item *ngFor="let c of reviewChanges">
          <strong>{{ c.field }}:</strong>
          <span class="before">{{ c.before }}</span>
          â†’
          <span class="after">{{ c.after }}</span>
        </mat-list-item>
      </mat-list>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="backToEditBudget()">Volver</button>
      <button mat-raised-button color="warn" (click)="confirmReviewBudget()">
        Confirmar
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<!-- Overlay de confirmaciÃ³n -->
<div
  class="overlay"
  *ngIf="showConfirmDeleteMembers || showConfirmDeleteBudgets || showConfirmDeleteExpenses"
>
  <mat-card class="confirm-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>warning</mat-icon>
        {{ showConfirmDeleteMembers   ? 'Eliminar miembros'    : '' }}
        {{ showConfirmDeleteBudgets   ? 'Eliminar presupuestos' : '' }}
        {{ showConfirmDeleteExpenses  ? 'Eliminar gastos'       : '' }}
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <p>Vas a borrar estos elementos:</p>
      <mat-list dense *ngIf="showConfirmDeleteMembers || showConfirmDeleteBudgets || showConfirmDeleteExpenses">
        <!-- Miembros -->
        <mat-list-item *ngFor="let u of selectedMembers">
          <mat-icon matListIcon>person</mat-icon>
          <div matLine>{{ u.nombre }} {{ u.apellidos }}</div>
        </mat-list-item>
        <!-- Presupuestos -->
        <mat-list-item *ngFor="let b of selectedBudgets">
          <mat-icon matListIcon>account_balance_wallet</mat-icon>
          <div matLine>{{ b.nombre }} â€” {{ b.cantidad | currency }}</div>
        </mat-list-item>
        <!-- Gastos -->
        <mat-list-item *ngFor="let g of selectedExpenses">
          <mat-icon matListIcon>shopping_cart</mat-icon>
          <div matLine>{{ g.descripcion }} â€” {{ g.cantidad | currency }}</div>
        </mat-list-item>
      </mat-list>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="
        showConfirmDeleteMembers   ? cancelDeleteMembers()  :
        showConfirmDeleteBudgets   ? cancelDeleteBudgets()  :
        cancelDeleteExpenses()
      ">
        Cancelar
      </button>
      <button mat-raised-button color="warn" (click)="
        showConfirmDeleteMembers   ? confirmDeleteMembers() :
        showConfirmDeleteBudgets   ? confirmDeleteBudgets() :
        confirmDeleteExpenses()
      ">
        <mat-icon>delete_forever</mat-icon>
        Confirmar
      </button>
    </mat-card-actions>
  </mat-card>
</div>