<!-- src/app/components/personal/personal.component.html -->
<div class="page-background">
  <mat-card *ngIf="user" class="user-card">
    <h2>Mis Datos</h2>

    <!-- =========================
         Secci√≥n de perfil
         ========================= -->
    <div class="profile-section">
      <img
        [src]="user.imagen_perfil || 'avatar-placeholder.png'"
        alt="Avatar"
        class="profile-avatar"
      />
      <p><strong>Nombre: </strong> {{ user.nombre }} {{ user.apellidos }}</p>
      <p><strong>Email: </strong> {{ user.email }}</p>
      <p><strong>Tel√©fono: </strong> {{ user.telefono || '‚Äî' }}</p>
    </div>

    <!-- =========================
         Mensajes de advertencia o error generales
         ========================= -->
    <!-- Se muestra s√≥lo si startEditInfo detect√≥ cuenta Google -->
    <div *ngIf="infoWarning" class="info-warning">
      {{ infoWarning }}
    </div>
    <!-- Mensaje de error al intentar abrir ‚Äúconfirmar edici√≥n‚Äù sin campos requeridos -->
    <div *ngIf="infoError" class="info-error">
      {{ infoError }}
    </div>

    <!-- =========================
         Botones de acci√≥n
         ========================= -->
    <div class="action-buttons">
      <!-- 1) Actualizar informaci√≥n -->
      <button
        mat-stroked-button
        color="primary"
        class="info-btn"
        (click)="startEditInfo()"
        *ngIf="!editingInfo"
      >
        ‚úèÔ∏è Actualizar mi informaci√≥n
      </button>

      <!-- 2) Actualizar contrase√±a -->
      <button
        mat-stroked-button
        color="primary"
        class="pwd-btn"
        (click)="showPwdForm = true"
        *ngIf="!showPwdForm"
      >
        üîë Actualizar mi contrase√±a
      </button>

      <!-- 3) Borrar usuario -->
      <button
        mat-stroked-button
        color="warn"
        class="delete-btn"
        (click)="showDeleteConfirm = true"
      >
        üóëÔ∏è Borrar mi usuario
      </button>
    </div>

    <!-- =========================
         FORMULARIO ‚ÄúActualizar mi informaci√≥n‚Äù
         ========================= -->
    <div *ngIf="editingInfo" class="edit-form edit-info">
      <h3>Editar mis datos</h3>
      <mat-form-field appearance="fill">
        <mat-label>Nombre</mat-label>
        <input matInput [(ngModel)]="edit.nombre" />
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Apellidos</mat-label>
        <input matInput [(ngModel)]="edit.apellidos" />
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Email</mat-label>
        <input matInput [(ngModel)]="edit.email" />
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Tel√©fono</mat-label>
        <input matInput [(ngModel)]="edit.telefono" />
      </mat-form-field>
      <div class="edit-actions">
        <button mat-button (click)="cancelEditInfo()">Cancelar</button>
        <button
          mat-flat-button
          color="accent"
          (click)="openInfoConfirm()"
        >
          Listo
        </button>
      </div>
    </div>

    <!-- =========================
         Mensaje de error para cambiar contrase√±a
         ========================= -->
    <div *ngIf="pwdError" class="pwd-error">
      {{ pwdError }}
    </div>

    <!-- =========================
         FORMULARIO ‚ÄúCambiar contrase√±a‚Äù
         ========================= -->
    <div *ngIf="showPwdForm" class="edit-form edit-pwd">
      <h3>Cambiar contrase√±a</h3>
      <mat-form-field appearance="fill">
        <mat-label>Contrase√±a actual</mat-label>
        <input
          matInput
          type="password"
          [(ngModel)]="pwd.current"
        />
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Nueva contrase√±a</mat-label>
        <input
          matInput
          type="password"
          [(ngModel)]="pwd.new"
        />
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Confirmar contrase√±a</mat-label>
        <input
          matInput
          type="password"
          [(ngModel)]="pwd.confirm"
        />
      </mat-form-field>
      <div class="edit-actions">
        <button mat-button (click)="showPwdForm = false">
          Cancelar
        </button>
        <button
          mat-flat-button
          color="accent"
          (click)="changePassword()"
        >
          Listo
        </button>
      </div>
    </div>

    <!-- =========================
         Confirm dialog PARA BORRAR CUENTA
         ========================= -->
    <ng-template #deleteConfirm>
      <h3>¬øEst√°s seguro que quieres borrar tu cuenta?</h3>
      <p>Se eliminar√°n todos tus datos y relaciones.</p>
      <div class="edit-actions">
        <button mat-button (click)="showDeleteConfirm = false">
          Cancelar
        </button>
        <button
          mat-flat-button
          color="warn"
          (click)="deleteAccount()"
        >
          Confirmar
        </button>
      </div>
    </ng-template>

    <!-- =========================
         Confirmaci√≥n de EDICI√ìN
         ========================= -->
    <ng-template #infoConfirm>
      <h3>Vas a cambiar tus datos a:</h3>
      <ul class="confirm-list">
        <li><strong>Nombre:</strong> {{ edit.nombre }} {{ edit.apellidos }}</li>
        <li><strong>Email:</strong> {{ edit.email }}</li>
        <li><strong>Tel√©fono:</strong> {{ edit.telefono }}</li>
      </ul>
      <div class="edit-actions">
        <button mat-button (click)="closeInfoConfirm()">
          Cancelar
        </button>
        <button
          mat-flat-button
          color="accent"
          (click)="doEditInfo()"
        >
          Confirmar
        </button>
      </div>
    </ng-template>

    <!-- =========================
         OVERLAY DE CONFIRMACIONES
         ========================= -->
    <!-- Overlay para BORRAR CUENTA -->
    <div
      class="overlay"
      *ngIf="showDeleteConfirm"
      (click)="showDeleteConfirm = false"
    >
      <div class="dialog" (click)="$event.stopPropagation()">
        <ng-container *ngTemplateOutlet="deleteConfirm"></ng-container>
      </div>
    </div>
    <!-- Overlay para CONFIRMAR EDICI√ìN -->
    <div
      class="overlay"
      *ngIf="showInfoConfirm"
      (click)="closeInfoConfirm()"
    >
      <div class="dialog" (click)="$event.stopPropagation()">
        <ng-container *ngTemplateOutlet="infoConfirm"></ng-container>
      </div>
    </div>
    <div class="back-container">
      <button
        mat-stroked-button
        class="back-btn"
        (click)="goHome()"
      >
        Volver a inicio
      </button>
    </div>
  </mat-card>
</div>

